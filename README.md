## Сборка проекта
- Склонировать репу *git clone git@github.com:connorholt/iq.git*
- В корне проекта запустить *make dev-start*, которая объединяет следующие команды:
   - docker-compose build --no-cache (может занять некоторое время)
   - chmod 777 на папку с логами
   - composer update
   - cache:clear
   - doctrine:migrations:migrate 
      - Параметры пока не подхватываются автоматом, надо ввести данные для бд в симфони
         - host: iq-db
         - port: 5432
         - database: db
         - user: db_user
         - pass: db_password
         

## Запуск проекта
- Первый раз нужно сделать все из *Сборка проекта*
- Запустить команду make dev-up (Если в консоль вывились состояния консьюмеров, это для отладки, просто нажмите enter)
- Для вставки начальных даных в таблицу баланса, нужно открыть главную страницу *localhost:8080/app_dev.php/* в будущем вынесу в seed

- После запуска сервисы доступны:
  - приложение *localhost:8080/app_dev.php/*
  - база данных (админер) *localhost:5000*
  - rabbitmq *localhost:15672*
  - kibana *localhost:81*  
  
## Протестировать работу
Для облегчения понимания, как работает система, в дефолтном контролере есть методы которые просто добавляют в очередь сообщения, чтобы было понятно структуру
- /test/ - начисление пользователю
- /withdraw/ - снятие денег
- /transfer/ - перевод от одного пользователя другому
- /lock/ - блокировка пользователя
- /lockWithdraw/ - снятие заблокированных денег
- /unlock/ - разблокировка пользователя

## Технологии используемые в проекте
- Docker
- Php 7.1, symfony 3.4
- Postgres 9.6
- Rabbitmq
- Redis
- Nginx, php-fpm
- Supervisor
- ELK

## Принцип работы
- Супервизор запускает консьюмер billingConsumer (10 процессов, это можно поменять)
- Консьюмеры разбирают очередь billing, куда приходят сообщения с определенными типами (примеры сообщение можно посмотреть тут: https://github.com/connorholt/iq/blob/master/backend/src/MemberBotBundle/Controller/DefaultController.php)
- По типу сообщения создается команда, которая кладется в комманд бас
- Комманд бас передает команду нужному обработчику
- Обработчик ставит лок в редисе (setnx) для пользователя, чтобы другие процессы не могли поменять ему баланс, сообщения которые не могут быть выполнены т.к. стоит лок возвращают статус reject (это можно легко изменить).
- Далее в транзакции выполняются запросы в базу данных
- Если было какое-то исключение или если все отработало локи снимаются, и файрится событие.
- В очередь отправляем подтверждение, что сообщение обработано
#### Принципы работы блокировки средств и снятия
- Событие блокировки, иммеет три типа: *lock*, *withdraw*, *unlock*
- Все три события должны иметь общий uuid, для того чтобы можно было менять состояние у заблокированных денег
- Когда приходит событие *lock*, у пользователя списываются деньги и создается запись в табице blocked_money
- Если приходит событие *unlock* то запись удаляется из *blocked_money* и деньги начисляются обратно человеку в таблице balance
- Если приходит событие *withdraw*, то деньги не возвращаются и удаляются из блокированных


## Доработки @todo
- Phpunit 
- EventListener
- Создать сиды для вставки изначальных данных
- Выпилить lockManager и использовать сервис симфони для лока
- Переименовать название бандла
- Перенести из контроллера тестовые функции в консоль
- Автоматизировать ввод параметров в симфони для бд
- Хеш для проверки сообщений из очереди

## Комманды
- make dev-start *билдит контейнеры, запускает, ставит все права как надо*
- make dev-build *собирает все*
- make dev-down *все выключает*
- make dev-clear *удалит все образы и контейнеры*

